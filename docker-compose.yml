services:
  snapserver:
    image: ghcr.io/lollonet/snapmulti-server:latest
    container_name: snapserver
    hostname: snapmulti
    restart: unless-stopped
    network_mode: host
    security_opt:
      - apparmor:unconfined
    user: "${PUID:-1000}:${PGID:-1000}"
    volumes:
      - ./config/snapserver.conf:/etc/snapserver.conf:ro
      - ./config:/config
      - ./data:/data
      - ./audio:/audio
      - /run/dbus/system_bus_socket:/run/dbus/system_bus_socket
    environment:
      - TZ=${TZ:-Europe/Berlin}
    command: ["snapserver", "-c", "/etc/snapserver.conf"]
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x snapserver || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  shairport-sync:
    image: ghcr.io/lollonet/snapmulti-airplay:latest
    container_name: shairport-sync
    restart: unless-stopped
    network_mode: host
    security_opt:
      - apparmor:unconfined
    user: "${PUID:-1000}:${PGID:-1000}"
    volumes:
      - ./audio:/audio
      - ./config/shairport-sync.conf:/etc/shairport-sync.conf:ro
      - /run/dbus/system_bus_socket:/run/dbus/system_bus_socket
    environment:
      - TZ=${TZ:-Europe/Berlin}
    depends_on:
      snapserver:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x shairport-sync || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  librespot:
    image: ghcr.io/lollonet/snapmulti-spotify:latest
    container_name: librespot
    restart: unless-stopped
    network_mode: host
    security_opt:
      - apparmor:unconfined
    user: "${PUID:-1000}:${PGID:-1000}"
    volumes:
      - ./audio:/audio
      - /run/dbus/system_bus_socket:/run/dbus/system_bus_socket
    environment:
      - TZ=${TZ:-Europe/Berlin}
    depends_on:
      snapserver:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x librespot || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  mympd:
    image: ghcr.io/jcorporation/mympd/mympd:latest
    container_name: mympd
    restart: unless-stopped
    network_mode: host
    user: "${PUID:-1000}:${PGID:-1000}"
    volumes:
      - ./mympd/workdir:/var/lib/mympd
      - ./mympd/cachedir:/var/cache/mympd
      - ${MUSIC_PATH:-/media/music}:/music:ro
      - ./mpd/playlists:/playlists:ro
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - MYMPD_HTTP_PORT=8180
      - MYMPD_SSL=false
    depends_on:
      mpd:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:8180/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  mpd:
    image: ghcr.io/lollonet/snapmulti-mpd:latest
    container_name: mpd
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./audio:/audio
      - ${MUSIC_PATH:-/media/music}:/music:ro
      - ./config/mpd.conf:/etc/mpd.conf:ro
      - ./mpd/playlists:/playlists
      - ./mpd/data:/data
    environment:
      - TZ=${TZ:-Europe/Berlin}
    healthcheck:
      test: ["CMD-SHELL", "echo 'ping' | nc -w 2 127.0.0.1 6600 | grep -q OK || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Tidal streaming bridge (optional, run on-demand)
  # Usage:
  #   docker compose --profile tidal run --rm tidal login      # One-time OAuth setup
  #   docker compose --profile tidal run --rm tidal play <url> # Play track/album/playlist
  #   docker compose --profile tidal run --rm tidal search <q> # Search Tidal
  tidal:
    image: ghcr.io/lollonet/snapmulti-tidal:latest
    container_name: tidal
    network_mode: host
    user: "${PUID:-1000}:${PGID:-1000}"
    profiles: ["tidal"]  # Only starts with: docker compose --profile tidal ...
    volumes:
      - ./tidal:/config
    environment:
      - TZ=${TZ:-Europe/Berlin}
      - TIDAL_SESSION_FILE=/config/tidal-session.json
      - TIDAL_QUALITY=${TIDAL_QUALITY:-high_lossless}
      - SNAPSERVER_HOST=127.0.0.1
      - SNAPSERVER_PORT=4953
    depends_on:
      snapserver:
        condition: service_healthy
